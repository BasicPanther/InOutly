<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üë§ My Dashboard</h2>
                <p id="employee-name"></p>
            </div>
            <nav class="sidebar-nav">
                <button class="nav-link active" onclick="showSection('overview')">üìä Overview</button>
                <button class="nav-link" onclick="showSection('tasks')">‚úÖ My Tasks</button>
                <button class="nav-link" onclick="showSection('attendance')">üìÖ Attendance</button>
                <button class="nav-link" onclick="showSection('projects')">üìÅ Projects</button>
                <button class="nav-link logout" onclick="logout()">üö™ Logout</button>
            </nav>
        </aside>

        <main class="main-content">
            <!-- Overview Section -->
            <section id="overview" class="section active">
                <h1>Welcome, <span id="welcome-name"></span>!</h1>
                <div class="stats-grid">
                    <div class="stat-card"><h3 id="stat-tasks">0</h3><p>My Tasks</p></div>
                    <div class="stat-card"><h3 id="stat-completed">0</h3><p>Completed</p></div>
                    <div class="stat-card"><h3 id="stat-projects">0</h3><p>Projects</p></div>
                    <div class="stat-card"><h3 id="stat-hours">0h</h3><p>Today's Hours</p></div>
                </div>
                <div class="today-status">
                    <h2>Today's Attendance</h2>
                    <div id="attendance-today"></div>
                </div>
            </section>

            <!-- Tasks Section -->
            <section id="tasks" class="section">
                <h1>My Tasks</h1>
                <div class="task-filters">
                    <button class="filter-btn active" onclick="filterTasks('all')">All</button>
                    <button class="filter-btn" onclick="filterTasks('pending')">Pending</button>
                    <button class="filter-btn" onclick="filterTasks('in_progress')">In Progress</button>
                    <button class="filter-btn" onclick="filterTasks('completed')">Completed</button>
                </div>
                <div id="task-list"></div>
            </section>

            <!-- Attendance Calendar Section -->
            <section id="attendance" class="section">
                <h1>Attendance Calendar</h1>
                <div class="calendar-controls">
                    <button onclick="changeMonth(-1)">‚Üê</button>
                    <h2 id="calendar-month"></h2>
                    <button onclick="changeMonth(1)">‚Üí</button>
                </div>
                <div class="calendar" id="calendar"></div>
                <div class="calendar-legend">
                    <span><span class="legend-dot present"></span> Present</span>
                    <span><span class="legend-dot absent"></span> Absent</span>
                    <span><span class="legend-dot today"></span> Today</span>
                </div>
                <div class="attendance-summary">
                    <h3>This Month Summary</h3>
                    <p>Present: <strong id="month-present">0</strong> days</p>
                    <p>Total Hours: <strong id="month-hours">0</strong>h</p>
                </div>
            </section>

            <!-- Projects Section -->
            <section id="projects" class="section">
                <h1>My Projects</h1>
                <div id="project-list" class="project-grid"></div>
            </section>
        </main>
    </div>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f5f5f5; }
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: #34495e; color: white; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-header h2 { font-size: 18px; margin-bottom: 5px; }
        .sidebar-header p { font-size: 12px; opacity: 0.8; }
        .sidebar-nav { padding: 10px; }
        .nav-link { width: 100%; padding: 12px 15px; background: none; border: none; color: white; text-align: left; cursor: pointer; border-radius: 5px; margin-bottom: 5px; font-size: 14px; }
        .nav-link:hover { background: rgba(255,255,255,0.1); }
        .nav-link.active { background: #3498db; }
        .nav-link.logout { margin-top: 20px; background: #e74c3c; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; }
        h1 { font-size: 28px; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-card h3 { font-size: 32px; color: #3498db; margin-bottom: 5px; }
        .stat-card p { color: #7f8c8d; font-size: 14px; }
        .today-status { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .today-status h2 { font-size: 20px; margin-bottom: 15px; }
        .task-filters { display: flex; gap: 10px; margin-bottom: 20px; }
        .filter-btn { padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer; }
        .filter-btn.active { background: #3498db; color: white; border-color: #3498db; }
        .task-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 5px; border-left: 4px solid #3498db; }
        .task-item h3 { margin-bottom: 5px; font-size: 16px; }
        .task-item p { color: #7f8c8d; font-size: 14px; margin-bottom: 10px; }
        .task-status { display: inline-block; padding: 4px 8px; border-radius: 3px; font-size: 12px; }
        .status-pending { background: #ffeaa7; color: #d63031; }
        .status-in_progress { background: #74b9ff; color: #0984e3; }
        .status-completed { background: #55efc4; color: #00b894; }
        .btn-complete { background: #2ecc71; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        
        /* Calendar Styles */
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px; }
        .calendar-controls button { background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .calendar { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .calendar-day-header { text-align: center; font-weight: 600; padding: 10px; color: #7f8c8d; font-size: 14px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #ecf0f1; border-radius: 5px; cursor: pointer; position: relative; }
        .calendar-day:hover { background: #f8f9fa; }
        .calendar-day.present { background: #d5f4e6; border-color: #27ae60; }
        .calendar-day.absent { background: #fadbd8; border-color: #e74c3c; }
        .calendar-day.today { border: 2px solid #3498db; font-weight: bold; }
        .calendar-day.disabled { color: #bdc3c7; background: #f8f9fa; }
        .calendar-legend { display: flex; gap: 20px; margin-bottom: 20px; }
        .legend-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
        .legend-dot.present { background: #27ae60; }
        .legend-dot.absent { background: #e74c3c; }
        .legend-dot.today { background: #3498db; }
        .attendance-summary { background: white; padding: 20px; border-radius: 10px; }
        .attendance-summary h3 { margin-bottom: 15px; }
        .attendance-summary p { margin-bottom: 10px; }
        
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .project-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .project-card h3 { margin-bottom: 10px; }
        .project-card p { color: #7f8c8d; font-size: 14px; }
        
        @media (max-width: 768px) { .sidebar { width: 200px; } .stats-grid { grid-template-columns: 1fr 1fr; } }
    </style>

    <script>
        let currentUser = null;
        let employeeData = null;
        let tasks = [];
        let projects = [];
        let attendanceData = [];
        let currentMonth = new Date();
        let filteredStatus = 'all';

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadData();
        });

        function checkAuth() {
            const user = sessionStorage.getItem('user');
            const employee = sessionStorage.getItem('employee');
            
            if (!user || !employee) {
                window.location.href = '/login';
                return;
            }
            
            currentUser = JSON.parse(user);
            employeeData = JSON.parse(employee);
            
            if (currentUser.role !== 'employee') {
                window.location.href = '/admin';
                return;
            }
            
            document.getElementById('employee-name').textContent = employeeData.name;
            document.getElementById('welcome-name').textContent = employeeData.name;
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = '/login';
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            event.target.classList.add('active');
            
            if (section === 'attendance') renderCalendar();
        }

        async function loadData() {
            await Promise.all([
                loadTasks(),
                loadProjects(),
                loadAttendance(),
                loadStats()
            ]);
        }

        async function loadTasks() {
            try {
                const res = await fetch(`/api/tasks?employee=${employeeData.id}`);
                tasks = await res.json();
                renderTasks();
            } catch (err) {
                console.error('Error loading tasks:', err);
            }
        }

        async function loadProjects() {
            try {
                const res = await fetch(`/api/projects`);
                const allProjects = await res.json();
                // Filter projects where employee is assigned
                projects = allProjects; // In production, filter by employee assignments
                renderProjects();
            } catch (err) {
                console.error('Error loading projects:', err);
            }
        }

        async function loadAttendance() {
            try {
                const today = new Date();
                const startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                
                const res = await fetch(`/api/attendance?employee=${employeeData.id}&startDate=${startDate}&endDate=${endDate}`);
                attendanceData = await res.json();
                renderTodayAttendance();
                renderCalendar();
            } catch (err) {
                console.error('Error loading attendance:', err);
            }
        }

        async function loadStats() {
            try {
                const res = await fetch(`/api/stats/dashboard?employee=${employeeData.id}`);
                const stats = await res.json();
                
                document.getElementById('stat-tasks').textContent = stats.tasks?.total || 0;
                document.getElementById('stat-completed').textContent = stats.tasks?.completed || 0;
                document.getElementById('stat-projects').textContent = stats.projects || 0;
                
                if (stats.todayAttendance && stats.todayAttendance.totalHours) {
                    document.getElementById('stat-hours').textContent = stats.todayAttendance.totalHours.toFixed(1) + 'h';
                }
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        function renderTodayAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecord = attendanceData.find(a => a.date === today);
            const container = document.getElementById('attendance-today');
            
            if (todayRecord) {
                const clockIn = todayRecord.clockIn ? new Date(todayRecord.clockIn).toLocaleTimeString() : '-';
                const clockOut = todayRecord.clockOut ? new Date(todayRecord.clockOut).toLocaleTimeString() : '-';
                const hours = todayRecord.totalHours ? todayRecord.totalHours.toFixed(2) + 'h' : '-';
                
                container.innerHTML = `
                    <p><strong>Clock In:</strong> ${clockIn}</p>
                    <p><strong>Clock Out:</strong> ${clockOut}</p>
                    <p><strong>Total Hours:</strong> ${hours}</p>
                `;
            } else {
                container.innerHTML = '<p>No attendance record for today</p>';
            }
        }

        function filterTasks(status) {
            filteredStatus = status;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderTasks();
        }

        function renderTasks() {
            const container = document.getElementById('task-list');
            let filtered = tasks;
            
            if (filteredStatus !== 'all') {
                filtered = tasks.filter(t => t.status === filteredStatus);
            }
            
            container.innerHTML = filtered.map(t => `
                <div class="task-item">
                    <h3>${t.title}</h3>
                    <p>${t.description || 'No description'}</p>
                    <span class="task-status status-${t.status}">${t.status.replace('_', ' ')}</span>
                    ${t.status !== 'completed' ? `<button class="btn-complete" onclick="completeTask(${t.id})">Mark Complete</button>` : ''}
                </div>
            `).join('');
        }

        async function completeTask(taskId) {
            try {
                await fetch(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'completed' })
                });
                await loadTasks();
                await loadStats();
            } catch (err) {
                alert('Error updating task');
            }
        }

        function renderProjects() {
            const container = document.getElementById('project-list');
            container.innerHTML = projects.map(p => `
                <div class="project-card">
                    <h3>${p.name}</h3>
                    <p>${p.description || 'No description'}</p>
                    <p><strong>Status:</strong> ${p.status}</p>
                    <p><strong>Priority:</strong> ${p.priority}</p>
                </div>
            `).join('');
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            document.getElementById('calendar-month').textContent = 
                currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            let calendarHTML = '<div class="calendar-grid">';
            
            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarHTML += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="calendar-day disabled"></div>';
            }
            
            // Calendar days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const attendance = attendanceData.find(a => a.date === dateStr);
                
                let classes = ['calendar-day'];
                if (date.toDateString() === today.toDateString()) classes.push('today');
                if (attendance && attendance.status === 'present') classes.push('present');
                if (!attendance && date < today) classes.push('absent');
                
                calendarHTML += `<div class="${classes.join(' ')}">${day}</div>`;
            }
            
            calendarHTML += '</div>';
            document.getElementById('calendar').innerHTML = calendarHTML;
            
            // Update summary
            const presentDays = attendanceData.filter(a => a.status === 'present').length;
            const totalHours = attendanceData.reduce((sum, a) => sum + (a.totalHours || 0), 0);
            
            document.getElementById('month-present').textContent = presentDays;
            document.getElementById('month-hours').textContent = totalHours.toFixed(1);
        }

        function changeMonth(delta) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + delta, 1);
            loadAttendance();
        }
    </script>
</body>
</html>